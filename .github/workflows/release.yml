name: Release

on:
  push:
    tags:
      - "v*"
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., v0.1.1)"
        required: true

permissions:
  contents: write

jobs:
  publish-win-x64:
    runs-on: windows-latest
    steps:
      - name: Checkout (attempt 1)
        uses: actions/checkout@v4
      - name: Wait before retry checkout
        if: ${{ failure() }}
        run: |
          echo "Checkout failed, waiting 20s before retry..."
          Start-Sleep -Seconds 20
        shell: pwsh
      - name: Checkout (attempt 2)
        if: ${{ failure() }}
        uses: actions/checkout@v4
      - name: Wait before retry checkout (final)
        if: ${{ failure() }}
        run: |
          echo "Second checkout failed, waiting 30s before final retry..."
          Start-Sleep -Seconds 30
        shell: pwsh
      - name: Checkout (attempt 3)
        if: ${{ failure() }}
        uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      - name: Restore
        run: dotnet restore WinFlow.sln
      - name: Publish Win-x64 (CLI)
        run: |
          dotnet publish WinFlow/WinFlow.Cli/WinFlow.Cli.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o publish/win-x64
      - name: Publish Win-x64 (ShellHost)
        run: |
          dotnet publish WinFlow/WinFlow.ShellHost/WinFlow.ShellHost.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o publish/win-x64
      - name: Publish Win-x64 (Installer)
        run: |
          dotnet publish WinFlow/WinFlow.Installer.Cli/WinFlow.Installer.Cli.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o publish/installer-win-x64
      - name: Bundle package contents
        shell: pwsh
        run: |
          # Place installer next to CLI so it can be used directly after unzip
          Copy-Item publish/installer-win-x64/WinFlow.Installer.Cli.exe publish/win-x64/ -Force
          # Add top-level files for convenience
          Copy-Item README.md publish/win-x64/ -Force
          if (Test-Path demo.wflow) { Copy-Item demo.wflow publish/win-x64/ -Force }
      - name: Zip artifacts (single bundle)
        shell: pwsh
        run: |
          Compress-Archive -Path publish/win-x64/* -DestinationPath winflow-win-x64.zip -Force
      - name: Determine tag
        id: vars
        shell: bash
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            echo "tag=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          fi
      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          target_commitish: ${{ github.sha }}
          files: |
            winflow-win-x64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
